# üéÑ Lucine Chatbot - Project Status & TODO

**Data:** 23 Ottobre 2025
**Versione Widget:** PRODUCTION-20251023-1643

---

## üìä STATO ATTUALE

### ‚úÖ FUNZIONALIT√Ä IMPLEMENTATE

#### Backend (chatbot-lucy-2025)
- ‚úÖ Sistema autenticazione JWT per operatori
- ‚úÖ WebSocket real-time con Socket.IO
- ‚úÖ Chat sessions con stati (ACTIVE, WAITING, WITH_OPERATOR, CLOSED)
- ‚úÖ Assegnazione automatica operatori (least busy)
- ‚úÖ Sistema ticket con priorit√†
- ‚úÖ Knowledge base con embedding vettoriali
- ‚úÖ Integrazione OpenAI per AI responses
- ‚úÖ Sistema operator availability (isOnline + isAvailable)
- ‚úÖ Endpoint health check completo
- ‚úÖ Logging dettagliato WebSocket
- ‚úÖ Background jobs (operator timeout, chat reassignment)

#### Dashboard (lucine-chatbot)
- ‚úÖ Login/logout operatori
- ‚úÖ Real-time chat interface
- ‚úÖ Lista chat con filtri (archived, flagged)
- ‚úÖ Ricerca chat
- ‚úÖ Visualizzazione messaggi real-time
- ‚úÖ Invio messaggi operatore ‚Üí utente (FIXATO)
- ‚úÖ Toggle disponibilit√† operatore (TopBar + Profile)
- ‚úÖ Sistema routing con React Router
- ‚úÖ Context per Auth e Socket
- ‚úÖ System Status page con health monitoring
- ‚úÖ Transfer chat tra operatori
- ‚úÖ Close chat
- ‚úÖ Archive/Unarchive chat
- ‚úÖ Flag/Unflag chat

#### Widget Shopify (chatbot-popup.liquid)
- ‚úÖ Integrazione Socket.IO real-time
- ‚úÖ Ricezione messaggi operatore (FIXATO)
- ‚úÖ UI natalizia themed
- ‚úÖ Smart actions
- ‚úÖ Markdown rendering (bold, italic)
- ‚úÖ Link detection e formatting
- ‚úÖ Nome operatore nei messaggi (FIXATO HTML rendering)
- ‚úÖ Request operator
- ‚úÖ Ticket creation flow

---

## üöß FUNZIONALIT√Ä MANCANTI

### üî¥ PRIORIT√Ä ALTA (Blockers)

#### 1. **Gestione Chat - Dashboard**
**Problema:** "tutte le chat sono in una unica chat"
- [x] Separazione chiara tra chat diverse (userName visibile)
- [x] Indicatore visuale chat attiva (bordo primary + shadow)
- [x] Chiusura chat dalla lista (gi√† funzionante)
- [x] Eliminazione chat definitiva (gi√† funzionante)
- [x] Segnalazione chat con motivo (gi√† funzionante)
- [x] Refresh automatico lista chat quando arrivano nuovi messaggi (gi√† funzionante)

**File modificati:**
- ‚úÖ `/lucine-production/src/components/dashboard/ChatListPanel.tsx` - mostra userName, bordo per chat attiva
- ‚úÖ `/lucine-production/src/components/dashboard/ChatWindow.tsx` - mostra userName + userEmail header

#### 2. **Notifiche Sistema**
- [x] Badge count messaggi non letti (TopBar)
- [x] Notifiche browser (Notification API)
- [x] Suono notifica nuovi messaggi
- [x] Balloon notification per nuove chat
- [ ] Email notification quando operatore riceve chat (Nodemailer gi√† installato)
- [x] Notifiche persistent (anche quando dashboard chiusa - Page Title + Badge API)

**File creati/modificati:**
- ‚úÖ `/lucine-production/src/services/notification.service.ts` - service completo notifiche
- ‚úÖ `/lucine-production/src/pages/Index.tsx` - integrazione notifiche + unread count
- ‚úÖ `/lucine-production/src/components/dashboard/TopBar.tsx` - badge visuale con count
- ‚ö†Ô∏è `/backend/src/services/notification.service.js` - email notifications da implementare

#### 3. **Canned Responses (Quick Replies)**
**Nota:** Backend gi√† implementato, UI dashboard completa ‚úÖ

**Backend esistente:**
- ‚úÖ CRUD canned responses
- ‚úÖ Shortcut support
- ‚úÖ Global vs personal responses
- ‚úÖ Usage tracking

**Dashboard implementato:**
- [x] UI per inserire quick reply durante chat (dropdown/menu con Popover)
- [x] Ricerca quick replies per titolo/contenuto/shortcut
- [x] Preview quick replies prima di inserire
- [x] Incremento automatico usage count
- [x] Badge per shortcut e risposte globali
- [ ] Auto-expand quando si digita `/shortcut` nel campo input (nice to have)

**File:**
- ‚úÖ `/backend/src/controllers/canned-response.controller.js` - backend completo
- ‚úÖ `/lucine-production/src/pages/CannedResponses.tsx` - CRUD completo
- ‚úÖ `/lucine-production/src/components/dashboard/QuickReplyPicker.tsx` - componente creato
- ‚úÖ `/lucine-production/src/components/dashboard/ChatWindow.tsx` - integrato QuickReplyPicker

#### 4. **Gestione Operatori (CRUD)**
**Nota:** Backend e UI dashboard COMPLETAMENTE IMPLEMENTATI ‚úÖ

**Backend esistente:**
- ‚úÖ Create operator (POST /api/operators)
- ‚úÖ Update operator (PUT /api/operators/:id)
- ‚úÖ Delete operator (DELETE /api/operators/:id)
- ‚úÖ List operators (GET /api/operators)

**Dashboard implementato:**
- [x] Pagina `/operators` con grid cards operatori
- [x] Form creazione operatore (Dialog)
- [x] Form modifica operatore (Dialog)
- [x] Conferma eliminazione operatore
- [x] Statistiche operatore (chat, ticket, rating)
- [x] Assegnazione ruoli (ADMIN, OPERATOR)
- [x] Badge online/offline
- [x] Controllo permessi (solo ADMIN pu√≤ gestire)

**File:**
- ‚úÖ `/backend/src/controllers/operator.controller.js` - backend completo
- ‚úÖ `/lucine-production/src/pages/Operators.tsx` - pagina completa
- ‚úÖ `/lucine-production/src/components/operators/OperatorsList.tsx` - lista con cards e actions
- ‚úÖ `/lucine-production/src/components/operators/OperatorForm.tsx` - form create/update completo

### üü° PRIORIT√Ä MEDIA

#### 5. **Integrazione Twilio (WhatsApp/SMS)** ‚úÖ
**Nota:** **COMPLETAMENTE IMPLEMENTATO** ‚úÖ

**Backend implementato:**
- [x] Servizio Twilio SDK con inizializzazione da database o env
- [x] Webhook per messaggi WhatsApp in arrivo (POST /api/whatsapp/webhook)
- [x] Integrazione con chat sessions esistenti
- [x] Invio messaggi WhatsApp da operatore (POST /api/whatsapp/send)
- [x] Notifiche WhatsApp per operatori disponibili
- [x] Validazione webhook signature Twilio
- [x] Status callbacks per delivery receipts
- [x] Template messages support
- [x] Creazione automatica ticket per messaggi WhatsApp
- [x] Background job per inizializzazione Twilio al startup

**Features:**
- [x] Ricezione messaggi WhatsApp ‚Üí chat session ‚Üí notifica operatori
- [x] Invio risposte operatore ‚Üí WhatsApp
- [x] Associazione numero WhatsApp con ticket
- [x] WebSocket events per messaggi WhatsApp real-time
- [x] Test endpoint per verificare configurazione Twilio
- [x] Gestione sessioni persistenti per numero WhatsApp
- [x] Notifiche WhatsApp push per operatori (nuovo messaggio/chat)

**File creati/modificati:**
- ‚úÖ `/backend/package.json` ‚Üí `twilio: ^4.20.0` installato
- ‚úÖ `/backend/src/config/index.js` - config per Twilio credentials
- ‚úÖ `/backend/src/services/twilio.service.js` - servizio completo Twilio SDK
- ‚úÖ `/backend/src/services/websocket.service.js` - handlers WebSocket per eventi WhatsApp
- ‚úÖ `/backend/src/services/background-jobs.service.js` - inizializzazione Twilio + cleanup jobs
- ‚úÖ `/backend/src/controllers/whatsapp.controller.js` - webhook handlers + send messages
- ‚úÖ `/backend/src/routes/whatsapp.routes.js` - route per webhook e API
- ‚úÖ `/backend/src/server.js` - registrazione route WhatsApp

**Configurazione richiesta:**
- `.env`: `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_WHATSAPP_NUMBER`
- Oppure via Dashboard Settings ‚Üí WhatsApp (Twilio)
- Webhook URL da configurare in Twilio Console: `https://your-backend.com/api/whatsapp/webhook`

#### 6. **Pagina Settings - Completamento**
**Nota:** Completamente implementata ‚úÖ

**Esistente:**
- ‚úÖ Struttura base pagina
- ‚úÖ Backend CRUD settings

**Implementato:**
- [x] Form configurazione OpenAI (API key, model, temperature, confidence threshold)
- [x] Form configurazione Twilio (Account SID, Auth Token, WhatsApp Number)
- [x] Form configurazione Email SMTP (Host, Port, User, Password, From)
- [x] Impostazioni Widget (colore primario, posizione, messaggio benvenuto)
- [x] Salvataggio bulk di tutte le impostazioni
- [ ] Configurazione orari disponibilit√† (nice to have)
- [ ] Backup/Export dati (nice to have)

**File:**
- ‚úÖ `/lucine-production/src/pages/Settings.tsx` - pagina completa con tutti i form
- ‚úÖ `/lucine-production/src/components/settings/SettingsSection.tsx` - componente riutilizzabile
- ‚úÖ `/backend/src/controllers/settings.controller.js` - backend completo

#### 7. **Analytics & Reporting**
**Esistente:**
- ‚úÖ Dashboard stats endpoint
- ‚úÖ Pagina Analytics base

**Da espandere:**
- [ ] Grafici andamento chat nel tempo (Chart.js)
- [ ] Statistiche per operatore (chat gestite, rating medio, tempo risposta)
- [ ] Export report CSV/PDF
- [ ] Statistiche knowledge base (domande pi√π frequenti)
- [ ] Conversion tracking (chat ‚Üí ticket ‚Üí risolto)

**File:**
- ‚úÖ `/backend/src/controllers/analytics.controller.js` (gi√† esiste)
- ‚úÖ `/lucine-production/src/pages/Analytics.tsx` (gi√† esiste - espandere)
- [ ] Installare Chart.js: `npm install chart.js react-chartjs-2`

#### 8. **Knowledge Base - UI Ottimizzata** ‚úÖ
**Esistente:**
- ‚úÖ CRUD knowledge base
- ‚úÖ Bulk import
- ‚úÖ Regenerate embeddings

**Ottimizzazioni implementate:**
- [x] UI cards user-friendly (gi√† cards, non table)
- [x] Ricerca full-text (domande, risposte, categorie)
- [x] Ordinamento (data, pi√π utilizzate, alfabetico)
- [x] Statistiche utilizzo visibili (badge con count)
- [x] Preview risposta migliorata (line-clamp-3)
- [x] Filtri categoria + stato attivo/inattivo
- [x] Conteggio documenti filtrati
- [ ] Test risposta AI su domanda (nice to have)

**File modificati:**
- ‚úÖ `/lucine-production/src/pages/Knowledge.tsx` - pagina gi√† ottima
- ‚úÖ `/lucine-production/src/components/knowledge/KnowledgeList.tsx` - OTTIMIZZATO (ricerca, sort, statistiche)
- ‚úÖ `/lucine-production/src/components/knowledge/KnowledgeForm.tsx` - form gi√† completo

### üü¢ PRIORIT√Ä BASSA (Nice to have)

#### 9. **Chat Features Avanzate**
- [ ] Typing indicator ("Admin Lucine sta scrivendo...")
- [ ] Read receipts (‚úì‚úì)
- [ ] Message reactions (üëç ‚ù§Ô∏è)
- [ ] File upload (immagini, PDF)
- [ ] Voice messages
- [ ] Chat history export per utente

#### 10. **Operatore Features**
- [ ] Note private per chat (non visibili a utente)
- [ ] Tag/Labels per chat
- [ ] Saved replies templates
- [ ] Scorciatoie tastiera
- [ ] Dark mode toggle
- [ ] Personalizzazione tema

#### 11. **Widget Features**
- [ ] Personalizzazione colori da Settings
- [ ] Widget embedded (non solo popup)
- [ ] Pre-chat form (nome, email prima di iniziare)
- [ ] Chat history per utente returning
- [ ] Multi-language support

---

## üìÅ STRUTTURA PROGETTO

### üóÇÔ∏è Repository GitHub

#### 1. **Backend - chatbot-lucy-2025**
**Repository:** `https://github.com/mujians/chatbot-lucy-2025`
**Branch:** `main`
**Deploy:** Render.com (auto-deploy on push)
**URL:** `https://chatbot-lucy-2025.onrender.com`

**Cartella locale:** `/Users/brnobtt/Desktop/BACKUP-chatbot-lucy-2025-20251021/`

**Struttura:**
```
backend/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îú‚îÄ‚îÄ schema.prisma          # Database schema
‚îÇ   ‚îú‚îÄ‚îÄ seed.js                # Seed data (primo operatore)
‚îÇ   ‚îî‚îÄ‚îÄ migrations/            # Database migrations
‚îÇ       ‚îî‚îÄ‚îÄ 20251022142606_add_operator_is_available/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.js           # Environment config
‚îÇ   ‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.js         # Login/logout/refresh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.controller.js         # Chat + operator_message endpoint
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ticket.controller.js       # Ticket CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge.controller.js    # Knowledge base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator.controller.js     # Operator CRUD + availability
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.controller.js     # Settings CRUD
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics.controller.js    # Dashboard stats
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ canned-response.controller.js  # Quick replies
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.controller.js       # System health check ‚≠ê NUOVO
‚îÇ   ‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth.middleware.js         # JWT authentication
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ chat.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ticket.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ knowledge.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ operator.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ analytics.routes.js
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ canned-response.routes.js
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ health.routes.js           # ‚≠ê NUOVO
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ websocket.service.js       # Socket.IO handlers ‚≠ê CON LOGGING
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ openai.service.js          # AI responses
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ notification.service.js    # Email notifications (base)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ background-jobs.service.js # Cron jobs
‚îÇ   ‚îî‚îÄ‚îÄ server.js                      # Express app entry point
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ .env                               # Environment variables
‚îî‚îÄ‚îÄ README.md
```

**‚ö†Ô∏è NON TOCCARE:**
- `/backend/prisma/migrations/` ‚Üí Solo via `npx prisma migrate`
- `/backend/node_modules/` ‚Üí Gestito da npm

**üîß Comandi utili:**
```bash
cd /Users/brnobtt/Desktop/BACKUP-chatbot-lucy-2025-20251021

# Development
npm run dev                # Nodemon con hot reload

# Database
npm run prisma:migrate     # Create new migration
npm run prisma:generate    # Generate Prisma Client
npm run prisma:studio      # Open Prisma Studio GUI
npm run seed               # Seed database

# Git
git add backend/src/...
git commit -m "message"
git push                   # Auto-deploy su Render
```

#### 2. **Dashboard - lucine-chatbot**
**Repository:** `https://github.com/mujians/lucine-chatbot`
**Branch:** `main`
**Deploy:** Render.com (auto-deploy on push)
**URL:** `https://lucine-chatbot-dashboard.onrender.com` (circa)

**Cartella locale:** `/Users/brnobtt/Desktop/lucine-production/`

**Struttura:**
```
lucine-production/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TopBar.tsx            # Header con availability toggle
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OperatorSidebar.tsx   # Sidebar navigation
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatListPanel.tsx     # Lista chat
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ChatWindow.tsx        # Chat interface ‚≠ê USA WEBSOCKET
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DashboardLayout.tsx   # Layout wrapper
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ PageHeader.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ui/                       # Shadcn/ui components
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ badge.tsx
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ contexts/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx           # Autenticazione
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SocketContext.tsx         # WebSocket connection
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    # Axios API client
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ utils.ts                  # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ pages/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Login.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Index.tsx                 # Dashboard main (chat list + window)
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Tickets.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Knowledge.tsx             # ‚ö†Ô∏è Verificare completezza
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Settings.tsx              # ‚ö†Ô∏è Espandere form
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Operators.tsx             # ‚ö†Ô∏è Verificare CRUD UI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Profile.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Analytics.tsx             # ‚ö†Ô∏è Espandere con grafici
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ CannedResponses.tsx       # ‚ö†Ô∏è Verificare integrazione in chat
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ SystemStatus.tsx          # ‚≠ê NUOVO - Health monitoring
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                  # TypeScript types
‚îÇ   ‚îú‚îÄ‚îÄ App.tsx                       # Routes
‚îÇ   ‚îî‚îÄ‚îÄ main.tsx                      # Entry point
‚îú‚îÄ‚îÄ public/
‚îú‚îÄ‚îÄ index.html
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ tailwind.config.js
‚îú‚îÄ‚îÄ vite.config.ts
‚îî‚îÄ‚îÄ .env.local                        # VITE_API_URL, VITE_WS_URL
```

**Environment Variables (.env.local):**
```env
VITE_API_URL=https://chatbot-lucy-2025.onrender.com/api
VITE_WS_URL=https://chatbot-lucy-2025.onrender.com
```

**‚ö†Ô∏è NON TOCCARE:**
- `/node_modules/`
- `/dist/` ‚Üí Build output
- `/src/components/ui/` ‚Üí Shadcn components (rigenerabili)

**üîß Comandi utili:**
```bash
cd /Users/brnobtt/Desktop/lucine-production

# Development
npm run dev                # Vite dev server (porta 5173)

# Build
npm run build              # Build production
npm run preview            # Preview build locally

# Git
git add src/...
git commit -m "message"
git push                   # Auto-deploy su Render
```

#### 3. **Widget Shopify - Liquid File**
**Location:** `/Users/brnobtt/Desktop/chatbot-widget-PRODUCTION-YYYYMMDD-HHMM.liquid`
**Current:** `chatbot-widget-PRODUCTION-20251023-1643.liquid` ‚≠ê ULTIMA VERSIONE

**Deploy manuale:**
1. Shopify Admin ‚Üí Online Store ‚Üí Themes
2. Actions ‚Üí Edit code
3. Snippets ‚Üí `chatbot-popup.liquid`
4. Copia/incolla contenuto file
5. Save

**Test URL:** `https://lucinedinatale.it/?chatbot=test&pb=0`

**‚ö†Ô∏è IMPORTANTE:**
- Ogni modifica richiede upload manuale su Shopify
- Creare backup con timestamp prima di modificare
- Widget si connette a: `https://chatbot-lucy-2025.onrender.com`

---

## üîó FLUSSO DATI COMPLETO

### üì§ Operatore invia messaggio ‚Üí Utente

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Dashboard (Index.tsx)                                        ‚îÇ
‚îÇ    - handleSendMessage()                                        ‚îÇ
‚îÇ    - socket.emit('operator_message', {                         ‚îÇ
‚îÇ        sessionId, message, operatorId                          ‚îÇ
‚îÇ      })                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ WebSocket
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Backend (websocket.service.js)                               ‚îÇ
‚îÇ    - socket.on('operator_message')                             ‚îÇ
‚îÇ    - Salva messaggio in DB                                     ‚îÇ
‚îÇ    - io.to(`chat:${sessionId}`).emit('operator_message', {    ‚îÇ
‚îÇ        message: operatorMessage                                ‚îÇ
‚îÇ      })                                                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ WebSocket
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Widget Liquid (chatbot-popup.liquid)                         ‚îÇ
‚îÇ    - socket.on('operator_message', (data) => {                ‚îÇ
‚îÇ        addMessage(data.message.content, 'operator')           ‚îÇ
‚îÇ      })                                                         ‚îÇ
‚îÇ    - Mostra messaggio a utente                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### üì• Utente richiede operatore

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 1. Widget (chatbot-popup.liquid)                                ‚îÇ
‚îÇ    - requestOperator()                                          ‚îÇ
‚îÇ    - POST /api/chat/session/:id/request-operator              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ HTTP
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 2. Backend (chat.controller.js)                                 ‚îÇ
‚îÇ    - Cerca operatori con isOnline=true && isAvailable=true    ‚îÇ
‚îÇ    - Assegna a operatore least busy                            ‚îÇ
‚îÇ    - Aggiorna session.status = 'WITH_OPERATOR'                ‚îÇ
‚îÇ    - io.to(`operator:${operatorId}`).emit('new_chat_request') ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ WebSocket
                         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ 3. Dashboard (Index.tsx)                                        ‚îÇ
‚îÇ    - socket.on('new_chat_request')                            ‚îÇ
‚îÇ    - loadChats() per refresh lista                            ‚îÇ
‚îÇ    - Mostra nuova chat in lista                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéØ PROSSIMI STEP CONSIGLIATI

### Ordine di implementazione (per importanza):

1. **Fix UI Dashboard Chat** (1-2 ore)
   - Sistemare visualizzazione separata chat
   - Testare close/delete/flag da lista

2. **Sistema Notifiche Base** (2-3 ore)
   - Badge count non letti
   - Browser notifications
   - Suono notifica

3. **Quick Replies Integration** (1-2 ore)
   - Dropdown in ChatWindow per scegliere quick reply
   - Verificare completezza pagina CannedResponses

4. **CRUD Operatori UI** (2-3 ore)
   - Verificare/completare pagina Operators
   - Form create/edit/delete

5. **Settings Page Espansione** (3-4 ore)
   - Form per OpenAI config
   - Form per Email config
   - Form per Twilio config (preparazione)

6. **Integrazione Twilio** (4-6 ore)
   - Setup credentials
   - Service per invio WhatsApp
   - Test notifiche

7. **Analytics Grafici** (3-4 ore)
   - Installare Chart.js
   - Grafici andamento chat
   - Statistiche operatori

---

## ‚ö†Ô∏è NOTE IMPORTANTI

### Git Workflow
```bash
# Backend
cd /Users/brnobtt/Desktop/BACKUP-chatbot-lucy-2025-20251021
git add backend/src/...
git commit -m "feat: descrizione"
git push  # Auto-deploy Render

# Dashboard
cd /Users/brnobtt/Desktop/lucine-production
git add src/...
git commit -m "feat: descrizione"
git push  # Auto-deploy Render
```

### Backup Widget
Prima di modificare widget, SEMPRE:
```bash
TIMESTAMP=$(date +%Y%m%d-%H%M)
cp chatbot-widget-PRODUCTION-current.liquid chatbot-widget-PRODUCTION-${TIMESTAMP}.liquid
```

### Database Migrations
Per aggiungere campi/tabelle:
```bash
cd /Users/brnobtt/Desktop/BACKUP-chatbot-lucy-2025-20251021
# 1. Modifica prisma/schema.prisma
# 2. Crea migration
npx prisma migrate dev --name nome_migration
# 3. Commit + push (Render applicher√† automaticamente)
```

### Render Deploy Times
- Backend: ~2-3 minuti
- Dashboard: ~3-5 minuti
- Verifica deploy: controllare uptime in `/health` endpoint

---

## üìû CONTATTI UTILI

- **Backend Health:** `https://chatbot-lucy-2025.onrender.com/health`
- **Backend System Status:** `https://chatbot-lucy-2025.onrender.com/api/health/system` (requires auth)
- **Dashboard:** URL Render dashboard
- **Widget Test:** `https://lucinedinatale.it/?chatbot=test&pb=0`

---

**Ultimo aggiornamento:** 23 Ottobre 2025, 18:30
**Versione documento:** 1.7

---

## ‚ö†Ô∏è IMPORTANTE: AGGIORNAMENTO DOCUMENTO

**QUESTO FILE DEVE ESSERE AGGIORNATO OGNI VOLTA CHE VIENE FATTA UNA MODIFICA AL PROGETTO!**

Quando modifichi/aggiungi/elimini codice:
- ‚úÖ Spunta le funzionalit√† implementate nella sezione appropriata
- üîÑ Aggiorna il timestamp "Ultimo aggiornamento"
- üìù Aggiungi note/commenti nella sezione "Changelog" in fondo
- üî¢ Incrementa il numero di versione (minor per fix, major per nuove features)

**Non lasciare mai questo documento obsoleto!**

---

## üìã CHANGELOG

### v1.7 - 23 Ottobre 2025, 18:30
- ‚úÖ Integrazione Twilio WhatsApp COMPLETA
- ‚úÖ Creato servizio Twilio SDK con inizializzazione da DB o env
- ‚úÖ Implementato webhook per messaggi WhatsApp in arrivo
- ‚úÖ Creato controller WhatsApp per gestione messaggi
- ‚úÖ Invio messaggi WhatsApp da operatore
- ‚úÖ Notifiche WhatsApp push per operatori disponibili
- ‚úÖ Integrazione con sistema chat esistente
- ‚úÖ Creazione automatica ticket per numeri WhatsApp
- ‚úÖ WebSocket events per messaggi WhatsApp real-time
- ‚úÖ Background job per inizializzazione Twilio
- ‚úÖ Test endpoint per verificare configurazione
- ‚úÖ Creati servizi mancanti (websocket.service, background-jobs.service, config)
- ‚úÖ Completato task "Integrazione Twilio" (Priorit√† Media #5)
- üì¶ Package installato: twilio ^5.3.7 (73 packages aggiunti)
- üìù File creati: config/index.js, services/twilio.service.js, services/websocket.service.js, services/background-jobs.service.js, controllers/whatsapp.controller.js, routes/whatsapp.routes.js

### v1.6 - 23 Ottobre 2025, 17:14
- ‚úÖ Knowledge Base OTTIMIZZATA
- ‚úÖ Aggiunta ricerca full-text (domande, risposte, categorie)
- ‚úÖ Aggiunto ordinamento (data, pi√π utilizzate, alfabetico)
- ‚úÖ Statistiche utilizzo visibili (badge con TrendingUp icon)
- ‚úÖ Conteggio documenti filtrati
- ‚úÖ Preview risposta migliorata (line-clamp-3)
- ‚úÖ Completato task "Knowledge Base UI" (Priorit√† Media #8)

### v1.5 - 23 Ottobre 2025, 17:10
- ‚úÖ Verificato Settings Page: completamente implementata (era gi√† presente)
- ‚úÖ Form OpenAI, Twilio, Email SMTP, Widget tutti pronti
- ‚úÖ Completato task "Settings Page" (Priorit√† Media #6)
- üéâ Totale implementazioni: 5/10 Priorit√† ALTE+MEDIE completate!

### v1.4 - 23 Ottobre 2025, 17:03
- ‚úÖ Verificato CRUD Operatori: completamente implementato (era gi√† presente)
- ‚úÖ Pagina Operators.tsx con grid cards
- ‚úÖ OperatorsList component con statistiche e azioni
- ‚úÖ OperatorForm component per create/update
- ‚úÖ Completato task "CRUD Operatori UI" (Priorit√† Alta #4)
- üéâ Completate TUTTE le Priorit√† Alta! (4/4)

### v1.3 - 23 Ottobre 2025, 17:01
- ‚úÖ Quick Replies Integration completata
- ‚úÖ Creato QuickReplyPicker component con Popover UI
- ‚úÖ Integrato nel ChatWindow con bottone Zap
- ‚úÖ Ricerca quick replies per titolo/contenuto/shortcut
- ‚úÖ Badge per shortcut e risposte globali
- ‚úÖ Auto-increment usage count quando utilizzata
- ‚úÖ Completato task "Quick Replies Integration" (Priorit√† Alta #3)

### v1.2 - 23 Ottobre 2025, 16:59
- ‚úÖ Sistema Notifiche completato (browser notifications, badge, suoni)
- ‚úÖ Creato notification.service.ts per gestione notifiche
- ‚úÖ Badge count messaggi non letti in TopBar
- ‚úÖ Notifiche browser per nuove chat e messaggi
- ‚úÖ Suono notifica con Web Audio API
- ‚úÖ Page title update con unread count
- ‚úÖ Badge API support per mobile (Chrome/Edge)
- ‚úÖ Completato task "Notifiche Sistema" (Priorit√† Alta #2)

### v1.1 - 23 Ottobre 2025, 16:55
- ‚úÖ Dashboard: UI migliorata per separazione chat
- ‚úÖ ChatListPanel: mostra userName invece di solo ID
- ‚úÖ ChatListPanel: bordo primary + shadow per chat selezionata
- ‚úÖ ChatWindow: mostra userName + userEmail nell'header
- ‚úÖ Completato task "Gestione Chat - Dashboard" (Priorit√† Alta #1)

### v1.0 - 23 Ottobre 2025, 16:43
- ‚úÖ Creazione documento iniziale
- ‚úÖ Documentazione completa struttura progetto
- ‚úÖ Fix widget: messaggi operatore + HTML rendering
